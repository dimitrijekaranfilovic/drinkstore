include /etc/nginx/drinkstore_conf.d/drinkstore_services.conf;

#API Gateway configuration
server {
	listen 9999;


	location = /api/users/authorize-admin {
		internal;
		access_log /var/log/nginx/user_service/access/authorize.log combined;
		error_log  /var/log/nginx/user_service/error/authorize.log;
		proxy_pass http://user_service;
	}


	location = /api/users/authorize-user {
		internal;
		access_log /var/log/nginx/user_service/access/authorize.log combined;
		error_log  /var/log/nginx/user_service/error/authorize.log; 
		proxy_pass http://user_service;
	}

	#user_service endpoints
	location = /api/users/register {
		limit_except POST {
			deny all;
		}
		error_page 403 = @405;
		
	        access_log /var/log/nginx/user_service/access/register.log combined;
		error_log  /var/log/nginx/user_service/error/register.log;
		proxy_pass http://user_service;
	}
	
	location = /api/users/authenticate {
		limit_except POST {
			deny all;
		}
		error_page 403 = @405;

		access_log /var/log/nginx/user_service/access/authenticate.log combined;
		error_log  /var/log/nginx/user_service/error/authenticate.log;
		proxy_pass http://user_service;
	}

	location ~ ^/api/users/ban/[a-zA-Z0-9_\-\.]+$ {
		limit_except GET {
			deny all;
		}
		auth_request /api/users/authorize-admin;
        	#error_page 403 = @405;

		access_log /var/log/nginx/user_service/access/ban.log combined;
		error_log  /var/log/nginx/user_service/error/ban.log;
		proxy_pass http://user_service;
	}

	

	location = /api/users/userId {
        	limit_except GET {
            		deny all;
       		 }
        	error_page 403 = @405;

		access_log /var/log/nginx/user_service/access/user_id_from_jwt.log combined;
		error_log  /var/log/nginx/user_service/error/user_id_from_jwt.log;
		proxy_pass http://user_service;
	}

	
	#drink_service endpoints
	location = /api/drinks/get {
        	limit_except GET {
            		deny all;
        	}
        	error_page 403 = @405;

		access_log /var/log/nginx/drink_service/access/get_drinks.log combined;
		error_log  /var/log/nginx/drink_service/error/get_drinks.log;
		proxy_pass http://drink_service;
	}

	location ~ ^/api/drinks/get/[0-9]+$ {
		limit_except GET {
			deny all;
		}
		error_page 403 = @405;
		access_log /var/log/nginx/drink_service/access/get_single_drink.log combined;
		error_log  /var/log/nginx/drink_service/error/get_single_drink.log;
		proxy_pass http://drink_service;
	}

	location = /api/drinks/create {
		limit_except POST {
			deny all;
		}
		auth_request /api/users/authorize-admin;
		#error_page 403 = @405;
		access_log /var/log/nginx/drink_service/access/create_drink.log combined;
		error_log  /var/log/nginx/drink_service/error/create_drink.log;
		proxy_pass http://drink_service;
	}
	
	location ~ ^/api/drinks/[0-9]+$ {
        	limit_except PUT DELETE {
           		deny all;
        	}
		auth_request /api/users/authorize-admin;
        	#error_page 403 = @405;

		access_log /var/log/nginx/drink_service/access/crud_single_drink.log combined;
		error_log  /var/log/nginx/drink_service/error/crud_single_drink.log;
		proxy_pass http://drink_service;
	}

	location ~ ^/api/drinks/[0-9]+/images$ {
        	limit_except POST {
            		deny all;
        	}
        	auth_request /api/users/authorize-admin;
		#error_page 403 = @405;

		access_log /var/log/nginx/drink_service/access/create_update_image.log combined;
		error_log  /var/log/nginx/drink_service/error/create_update_image.log;
		proxy_pass http://drink_service;
	}

	location ~ ^/api/drinks/[0-9]+/grades$ {
        	limit_except POST {
            		deny all;        
        	}
        	auth_request /api/users/authorize-user;	
		#error_page 403 = @405;
	
		access_log /var/log/nginx/drink_service/access/create_grade.log combined;
		error_log  /var/log/nginx/drink_service/error/create_grade.log;
		proxy_pass http://drink_service;
	}

	location ~ ^/api/drinks/[0-9]+/grades/[0-9]+ {
        	limit_except PUT DELETE {
            		deny all;        
        	}
        	auth_request /api/users/authorize-user;
		#error_page 403 = @405;
		access_log /var/log/nginx/drink_service/access/update_delete_grade.log combined;
		error_log  /var/log/nginx/drink_service/error/update_delete_grade.log;
		proxy_pass http://drink_service;
	}

	location ~ ^/api/drinks/[0-9]+/grade-for-user$ {
        	limit_except GET {
            		deny all;        
        	}
        	auth_request /api/users/authorize-user;
		#error_page 403 = @405;
		access_log /var/log/nginx/drink_service/access/grade_for_user.log combined;
		error_log  /var/log/nginx/drink_service/error/grade_for_user.log;
		proxy_pass http://drink_service;
	}

	location ~ ^/api/drinks/images/[a-zA-Z0-9_\-]+\.[a-zA-Z]+$ {
        	limit_except GET {
            		deny all;        
        	}
        	error_page 403 = @405;
		access_log /var/log/nginx/drink_service/access/get_image.log combined;
		error_log  /var/log/nginx/drink_service/error/get_image.log;
		proxy_pass http://drink_service;
	}
		
	#comment_service endpoints
	location = /api/comments {
        	limit_except POST {
            		deny all;        
        	}
        	auth_request /api/users/authorize-user;
		#error_page 403 = @405;
		access_log /var/log/nginx/comment_service/access/create_comment.log combined;
		error_log  /var/log/nginx/comment_service/error/create_comment.log;
		proxy_pass http://comment_service;
	}

	location = /api/comments/reports/create {
        	limit_except POST {
            		deny all;        
        	}
        	#error_page 403 = @405;
		auth_request /api/users/authorize-user;
		access_log /var/log/nginx/comment_service/access/create_report.log combined;
		error_log  /var/log/nginx/comment_service/error/create_report.log;
		proxy_pass http://comment_service;
	}
	
	location = /api/comments/reports/get {
		limit_except GET{
			deny all;
		}
		auth_request /api/users/authorize-admin;
		access_log /var/log/nginx/comment_service/access/get_reports.log combined;
		error_log  /var/log/nginx/comment_service/error/get_reports;
		proxy_pass http://comment_service;
	}

	location ~ ^/api/comments/for-drink/[0-9]+$ {
        	limit_except GET {
            		deny all;        
		}
        	error_page 403 = @405;
		access_log /var/log/nginx/comment_service/access/get_comments_for_drink.log combined;
		error_log  /var/log/nginx/comment_service/error/get_comments_for_drink.log;
		proxy_pass http://comment_service;	
	}

	location ~ ^/api/comments/[a-zA-Z0-9_\-]+$ {
        	limit_except DELETE {
            		deny all;        
        	}
        	auth_request /api/users/authorize-admin;
		#error_page 403 = @405;
		access_log /var/log/nginx/comment_service/access/delete_comment.log combined;
		error_log  /var/log/nginx/comment_service/error/delete_comment.log;
		proxy_pass http://comment_service; 
	}

	location ~ ^/api/comments/reports/[a-zA-Z0-9_\-]+$ {
        	limit_except DELETE {
            		deny all;        
        	}
		auth_request /api/users/authorize-admin;
        	#error_page 403 = @405;
		access_log /var/log/nginx/comment_service/access/delete_report.log combined;
		error_log  /var/log/nginx/comment_service/error/delete_report.log;
		proxy_pass http://comment_service;
	}

	#purchase_service endpoints
	location ~ /api/purchases/history-for-user/[0-9]+$ {
		limit_except GET {
			deny all;
		}
		auth_request /api/users/authorize-user;
		access_log /var/log/nginx/purchase_service/access/get_user_history.log combined;
		error_log  /var/log/nginx/purchase_service/error/get_user-history.log;
		proxy_pass http://purchase_service;
	}

	location = /api/purchases {
		limit_except POST {
			deny all;
		}
		auth_request /api/users/authorize-user;
		access_log /var/log/nginx/purchase_service/access/create_purchase.log combined;
		error_log  /var/log/nginx/purchase_service/error/create_purchase.log;
		proxy_pass http://purchase_service;
	}

	error_page 404 = @404;
	include /etc/nginx/api_json_errors.conf;
	default_type application/json;

}
